<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>closet Â· admin</title>
    <link rel="icon" href="../favicon.svg" type="image/svg+xml" />
    <style>
      :root { color-scheme: dark light; }
      html, body { height: 100%; margin: 0; }
      body { font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    </style>
  </head>
  <body>
    <!-- Decap CMS (manual init) -->
    <script>window.CMS_MANUAL_INIT = true;</script>
    <script src="https://unpkg.com/decap-cms@latest/dist/decap-cms.js?v=3"></script>
    <script>
      // Netlify Identity widget + explicit APIUrl so it doesn't call /.netlify/identity on this domain
      (function() {
        var s = document.createElement('script');
        s.src = 'https://identity.netlify.com/v1/netlify-identity-widget.js';
        s.async = true;
        s.onload = function() {
          if (window.netlifyIdentity) {
            window.netlifyIdentity.init({
              APIUrl: 'https://closet-api-towards.netlify.app/.netlify/identity'
            });
            function ensureFullNameLocal(user) {
              try {
                if (!user) return;
                if (!user.user_metadata) user.user_metadata = {};
                if (!user.user_metadata.full_name) {
                  user.user_metadata.full_name = (user.email || '').split('@')[0] || 'user';
                }
              } catch (e) {}
            }
            function startCMS() {
              if (window.CMS && typeof window.CMS.init === 'function') {
                try { window.CMS.init(); } catch (e) { console.error('CMS init failed', e); }
              }
            }
            window.netlifyIdentity.on('init', function(user){
              ensureFullNameLocal(user);
              startCMS();
            });
            window.netlifyIdentity.on('login', function(user){
              ensureFullNameLocal(user);
              try { window.netlifyIdentity.close(); } catch(e) {}
              startCMS();
            });
            window.netlifyIdentity.on('logout', function(){
              startCMS();
            });
            // If no identity events fire (e.g., guest), still init CMS
            setTimeout(startCMS, 400);
          }
        };
        document.body.appendChild(s);
      })();
    </script>
  </body>
  </html>


